<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
{{ form.media }}
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/">

	<!-- title -->
	<title>Chapfood</title>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
	 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
	<!-- favicon -->
	<link rel="shortcut icon" type="image/png" href="{% static 'assets/img/favicon.png' %}">
	<!-- google font -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
	<!-- fontawesome -->

	<link rel="stylesheet" href="{% static 'assets/css/all.min.css' %}">
	<!-- bootstrap -->
	<link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}">
	<!-- owl carousel -->
	<link rel="stylesheet" href="{% static 'assets/css/owl.carousel.css' %}">
	<!-- magnific popup -->
	<link rel="stylesheet" href="{% static 'assets/css/magnific-popup.css' %}">
	<!-- animate css -->
	<link rel="stylesheet" href="{% static 'assets/css/animate.css' %}">
	<!-- mean menu css -->
	<link rel="stylesheet" href="{% static 'assets/css/meanmenu.min.css' %}">
	<!-- main style -->
	<link rel="stylesheet" href="{% static 'assets/css/main.css' %}">
	<!-- responsive -->
	<link rel="stylesheet" href="{% static 'assets/css/responsive.css' %}">
	
	
</head>
<body>
	
	<!--PreLoader-->
    <div class="loader">
        <div class="loader-inner">
            <div class="circle"></div>
        </div>
    </div>
    <!--PreLoader Ends-->
	
	<!-- header -->
    <style>
        #sticky-logo {
            display: none;
        }
    
    </style>
    <div class="top-header-area" id="sticker">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-sm-12 text-center">
                    <div class="main-menu-wrap">
                        <!-- logo -->
                        <div class="site-logo">
                            <a href="{% url 'base:index' %}">
                                <img id="logo" src="{% static 'assets/img/chapfood.png'%}" alt="">
                                <img id="sticky-logo" src="{% static 'assets/img/logo2.png' %}" alt="Sticky Logo">
                            </a>
                        </div>
                        <!-- logo -->

                        <!-- menu start -->
                        <nav class="main-menu">
                            <ul>
                                <li class="current-list-item"><a href="{% url 'base:index' %}">Home</a>
                                    <ul class="sub-menu">
                                        <li><a href="{% url 'base:index' %}">Static Home</a></li>
                                        <li><a href="{% url 'base:index' %}">Slider Home</a></li>
                                    </ul>
                                </li>
                                <li><a href="{% url 'base:about' %}">About</a></li>
                                <li><a href="{% url 'base:meal_list' %}">shop</a>
                                    <ul class="sub-menu">
                                        <li><a href="{% url 'base:index' %}">Home</a></li>
                                        
                                        <li><a href="{% url 'base:cart' %}">Mon panier</a></li>
                                        <li><a href="{% url 'base:checkout' %}">Ma commande</a></li>
                                        
                                        <li><a href="{% url 'base:meal_list' %}">Nos repas</a></li>
                                    </ul>
                                </li>

                                <li><a href="{% url 'base:contact' %}">Contact</a></li>
                                <li><a href="#">Connexion</a>
                                    <ul class="sub-menu">
                                        <li><a href="{% url 'accounts:signup' %}">S'enregistrer</a></li>
                                        <li><a href="{% url 'livreurs:depot-dossiers' %}">inscription livreur</a></li>
                                        {% if user.is_authenticated %}
                                            <li><a href="{% url 'accounts:logout' %}">Se déconnecter</a></li>
                                            <li><a href="{% url 'accounts:password_reset' %}">Réinitialiser son mot de passe</a></li>
                                        {% else %}
                                            <li><a href="{% url 'accounts:login' %}">Se connecter</a></li>
                                            <li><a href="{% url 'accounts:forget_password_reset' %}">Réinitialiser son mot de passe</a></li>
                                        {% endif %}
                                        
                                    </ul>
                                </li>
                                <li>
                                    <div class="header-icons">
                                        <a class="shopping-cart position-relative d-inline-flex" href="{% url 'base:cart' %}">
                                        <i class="fas fa fa-shopping-cart fa-lg"></i>
                                        <span class="cart-basket d-flex align-items-center justify-content-center" id="totalPanier">
                                            {{quantite_panier}}
                                        </span>
                                        </a>
                                        <a class="mobile-hide search-bar-icon" href="#"><i class="fas fa-search"></i></a>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                        <a class="mobile-show search-bar-icon" href="#"><i class="fas fa-search"></i></a>
                        <div class="mobile-menu"></div>
                        <!-- menu end -->
                    </div>
                </div>
            </div>
        </div>
    </div>

        
	<!-- end header -->
	
	<!-- search area -->
	<div class="search-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<span class="close-btn"><i class="fas fa-window-close"></i></span>
					<div class="search-bar">
						<div class="search-bar-tablecell">
							<h3>Search For:</h3>
							<form method="GET" action="{% url 'base:index' %}">
							<input type="text" name="q" placeholder="Keywords">
							<button type="submit">Search <i class="fas fa-search"></i></button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end search area -->



		<!-- cart -->
<div class="breadcrumb-section breadcrumb-bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 text-center">
                <div class="breadcrumb-text">
                    <p>Solution Innovante</p>
                    <h1>Panier</h1>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="cart-section mt-50 mb-150">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-12">
                <div class="cart-table-wrap">
                    <table class="cart-table">
                        <thead class="cart-table-head">
                            <tr class="table-head-row">
                                <th class="product-remove"></th>
                                <th class="product-image-cart">produit</th>
                                <th class="product-name">nom</th>
                                <th class="product-price">prix</th>
                                <th class="product-quantity">quantité</th>
                                <th class="product-total">total</th>
                            </tr>
                        </thead>
                        <tbody>
              {% for item in cart.cartitemmeal_set.all %}
                            <tr class="table-body-row">
                                <td class="product-remove"><a href="#" id="remove-from-cart-{{ item.meal.id }}"><i class="far fa-window-close"></i></a></td>
                                <td class="product-image-cart"><img src="{{ item.meal.image.url }}" alt=""></td>
                                <td class="product-name">{{ item.meal.name }}</td>
                                {% if item.meal.is_promo%}
                                <td class="product-price">{{ item.meal.second_price }}cfa</td>
                                {% else %}
                                <td class="product-price">{{ item.meal.price }}cfa</td>
                                {% endif %}
                                <td class="product-quantity">								
                                <input class="rounded-input ted" type="number" name="quantity" value="{{ item.quantity }}" min="1" id="quantity-input-{{ item.meal.id }}">									
                                </td>                      
                                <td class="product-total" id="product_total-{{ item.meal.id }}">{{ item.calculate_item_total }}</td>
                                <script>
                                    // Sélectionnez l'élément d'entrée de quantité et le formulaire
                                    //const quantityInput = document.getElementById("quantity-input-{{ item.meal.id }}");
                                    //const cartUpdateForm = document.getElementById("cart-update-form-{{ item.meal.id }}");
                                    
                                    var newQuantity = 0;
                                    
                                      
                                    // Écoutez l'événement de modification de la quantité
                                    document.getElementById("quantity-input-{{ item.meal.id }}").addEventListener("change", function (event) {
                                        event.preventDefault();
                                        newQuantity = document.getElementById("quantity-input-{{ item.meal.id }}").value;
                                        console.log('essai'+newQuantity)
                                        const updateURL = `{% url 'base:update_cart' item.meal.id 0 %}`.replace('0', newQuantity);
                                        // Soumettez le formulaire lorsque la quantité est modifiée
                                        fetch(updateURL)
                                            .then(response => response.json())
                                            .then(data => {
                                                // Gérer la réponse du serveur (par exemple, mettre à jour l'affichage du panier)
                                                
                                                document.getElementById("product_total-{{ item.meal.id }}").textContent = data.item_total;
                                                document.getElementById("total_cart").textContent = data.cart_total;
                                                document.getElementById("sub_total_cart").textContent = data.cart_total;

                                            })
                                            .catch(error => {
                                                console.error('Erreur lors de l\'ajout au panier :', error);
                                            });
                                    });
                                    document.getElementById('remove-from-cart-{{ item.meal.id }}').addEventListener('click', function (event) {
                                        event.preventDefault();
                                        // Récupérer le produit à ajouter
                                        //const productID = {{meal.id}}; // ID du produit

                                        // Effectuer une requête AJAX pour ajouter le produit au panier
                                        fetch(`{% url 'base:remove_from_cart' item.meal.id %}`)
                                            .then(response => response.json())
                                            .then(data => {
                                                // Gérer la réponse du serveur (par exemple, mettre à jour l'affichage du panier)
                                                
                                                //document.getElementById("product_total-{{ item.meal.id }}").textContent = data.item_total;
                                                document.getElementById("total_cart").textContent = data.cart_total;
                                                document.getElementById("sub_total_cart").textContent = data.cart_total;
                                                const row = this.closest('tr'); // Trouvez l'élément tr parent
                                                row.remove(); // Supprimez la ligne du panier du DOM
                                            })
                                            .catch(error => {
                                                console.error('Erreur lors de l\'ajout au panier :', error);
                                            });										
                                    });

                                    var panier = JSON.parse(localStorage.getItem('panier'));
                                    $(document).on('click', '.ted', function(){
                                    console.log('ajouter');
                                    var item_id = this.id.toString().substring(15);
                                    console.log("total"+item_id)
                                    
                                    if(panier[item_id] != undefined){
                                        quantite = panier[item_id][0] +1 ;
                                        panier[item_id][0] = quantite;
                                        panier[item_id][2] += parseFloat(document.getElementById("price"+item_id).innerHTML);
                                    }
                                    console.log(panier);
                                    //localStorage.setItem('panier', JSON.stringify(panier));
                                    
                                    });
                                </script>

                            </tr>
            {%endfor%}
    
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="total-section">
                    <table class="total-table">
                        <thead class="total-table-head">
                            <tr class="table-total-row">
                                <th>Total</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {%if ancien_total%}
                                <tr class="total-data">
                                    <td><strong>Ancien total: </strong></td>
                                    <td>{{ancien_total}}cfa</td>
                                </tr>
                                <tr class="total-data">
                                <td><strong>Nouveau total: </strong></td>
                                <td id="sub_total_cart">{{total}}cfa</td>
                            </tr>
                            {% else %}
                            <tr class="total-data">
                                <td><strong>Subtotal: </strong></td>
                                <td id="sub_total_cart">{{total}}cfa</td>
                            </tr>
                            
                                <tr class="total-data">
                                <td><strong>TVA: </strong></td>
                                <td id="sub_total_cart">0</td>
                            </tr>
                            <tr class="total-data">
                                <td><strong>Total: </strong></td>
                                <td id="total_cart">{{total}}cfa</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="cart-buttons">
                    
                        <a href="{% url 'base:checkout' %}" class="boxed-btn black">Check Out</a>
                    </div>
                </div>

            <div class="coupon-section">
                    <h3>Apply Coupon</h3>
                    <div class="coupon-form-wrap">
                        <form method="GET" action="{% url 'base:cart' %}">
                            <p><input name ="code_promo" type="text" placeholder="code promo"></p>
                            <p><input type="submit" value="Apply"></p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const originalLogo = document.getElementById("logo");
        const stickyLogo = document.getElementById("sticky-logo");

        window.addEventListener("scroll", function() {
            if (window.scrollY > 0) { // Vous pouvez ajuster cette valeur en fonction de la position de défilement où vous voulez changer le logo.
                originalLogo.style.display = "none";
                stickyLogo.style.display = "block";
            } else {
                originalLogo.style.display = "block";
                stickyLogo.style.display = "none";
            }
        });
    });
        
    const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsEndpoint = `${websocketProtocol}://${window.location.host}/ws/notification_type4/`;
    const socket = new WebSocket(wsEndpoint);
    
    // Écoute des messages entrants
document.addEventListener('DOMContentLoaded', (event) => {
    socket.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "notification_type4") {
            const itemCount = data.message;
            // Utilise itemCount pour afficher la notification où tu le souhaites dans ta page web
            // Par exemple :
    
            console.log("total article panier : "+itemCount)
            document.getElementById('totalPanier').innerHTML=itemCount;  // Affichage de l'icone du nombre d'
        }
    });
});
    
</script>
 
	<!-- end logo carousel -->
{% include "footer.html" %}
	<!-- footer -->
	
	<!-- end copyright -->
	
	<!-- jquery -->
	
	<script src="{% static 'assets/js/jquery-1.11.3.min.js' %}"></script>
	<!-- bootstrap -->
	<script src="{% static 'assets/bootstrap/js/bootstrap.min.js' %}"></script>
	<!-- count down -->
	<script src="{% static 'assets/js/jquery.countdown.js' %}"></script>
	<!-- isotope -->
	<script src="{% static 'assets/js/jquery.isotope-3.0.6.min.js' %}"></script>
	<!-- waypoints -->
	<script src="{% static 'assets/js/waypoints.js' %}"></script>
	<!-- owl carousel -->
	<script src="{% static 'assets/js/owl.carousel.min.js' %}"></script>
	<!-- magnific popup -->
	<script src="{% static 'assets/js/jquery.magnific-popup.min.js' %}"></script>
	<!-- mean menu -->
	<script src="{% static 'assets/js/jquery.meanmenu.min.js' %}"></script>
	<!-- sticker js -->
	<script src="{% static 'assets/js/sticker.js' %}"></script>
	<!-- main js -->
	<script src="{% static 'assets/js/main.js' %}"></script>

</body>
{% block js %}
	<script type='text/javascript'>
		console.log('juste pour tester');
		if(localStorage.getItem('panier') == null){
            var panier = {};
        }else{
            panier = JSON.parse(localStorage.getItem('panier'));
        }
		$(document).on('click', '.ted', function(){
            console.log('ajouter');
			var item_id = this.id.toString().substring(19);
            
			if(panier[item_id] != undefined){
                quantite = panier[item_id][0] +1 ;
                panier[item_id][0] = quantite;
                panier[item_id][2] += parseFloat(document.getElementById("price"+item_id).innerHTML);
            }else{
                quantite = 1;
                prix = parseFloat(document.getElementById("price"+item_id).innerHTML);
                nom =  document.getElementById("name"+item_id).innerHTML;
                panier[item_id] = [quantite, nom, prix ];
                
            }
            console.log(panier);
            localStorage.setItem('panier', JSON.stringify(panier));
			
			});
			
			
	</script>

{% endblock  %}
</html>